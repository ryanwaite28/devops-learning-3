pipeline {
  agent {
    kubernetes {
      label 'k8s-agent-smoke'
      defaultContainer 'tools'
      yaml """
apiVersion: v1
kind: Pod
spec:
  volumes:
    - name: trivy-cache
      emptyDir: {}

  serviceAccountName: jenkins-ci
  restartPolicy: Never
  securityContext:
    fsGroup: 1000
  containers:
    - name: jnlp
      image: jenkins/inbound-agent:jdk17
      resources:
        requests: { cpu: "100m", memory: "256Mi" }
        limits:   { cpu: "500m", memory: "512Mi" }
    - name: tools
      image: ci-tools:0.1.0
      imagePullPolicy: IfNotPresent
      command: ["bash", "-lc", "cat"]
      tty: true
      volumeMounts:
        - name: trivy-cache
          mountPath: /home/jenkins/agent/.cache/trivy
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      resources:
        requests: { cpu: "200m", memory: "512Mi" }
        limits:   { cpu: "1000m", memory: "1Gi" }
      env:
        - name: TRIVY_CACHE_DIR
          value: $WORKSPACE/.cache/trivy
"""
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
  }

  environment {
    REPORTS_DIR = "reports"

    HOME = "${env.WORKSPACE}"
    CI_HOME = "${env.WORKSPACE}"
    XDG_CACHE_HOME = "${env.WORKSPACE}/.cache"
    XDG_CONFIG_HOME = "${env.WORKSPACE}/.config"
    SEMGREP_USER_HOME = "${env.WORKSPACE}/.semgrep"
    SEMGREP_DISABLE_VERSION_CHECK = "1"
    SEMGREP_SEND_METRICS = "off"
  }

  stages {
    stage('SCM + Agent Smoke Test') {
      steps {
        sh '''
          set -eux
          echo "Hello from Kubernetes agent"
          uname -a
          ls -la
        '''
      }
    }

    stage('Prepare CI Workspace') {
      steps {
        sh '''
          set -eux
          mkdir -p "$XDG_CACHE_HOME" "$XDG_CONFIG_HOME" "$SEMGREP_USER_HOME" reports
          touch "$XDG_CACHE_HOME/.write_test"
          touch "$XDG_CONFIG_HOME/.write_test"
          touch "$SEMGREP_USER_HOME/.write_test"
          rm -f "$XDG_CACHE_HOME/.write_test" "$XDG_CONFIG_HOME/.write_test" "$SEMGREP_USER_HOME/.write_test"
        '''
      }
    }

    stage('Tool Versions') {
      steps {
        sh '''
          set -eux
          export HOME="$CI_HOME"
          semgrep --version
          syft version
          trivy --version
          sonar-scanner --version
          yq --version
        '''
      }
    }

    stage('SAST: Semgrep') {
      steps {
        sh '''
          set -eux
          mkdir -p "$SEMGREP_USER_HOME"
          mkdir -p "${REPORTS_DIR}"

          export HOME="$CI_HOME"

          semgrep --metrics off --config p/ci --json -o reports/semgrep.json . || true
          # Gate: fail if any findings exist in the JSON
          python3 - <<'PY'
import json, sys
p="reports/semgrep.json"
data=json.load(open(p))
results=data.get("results", [])
print(f"Semgrep findings: {len(results)}")
sys.exit(1 if len(results) > 0 else 0)
PY
        '''
      }
    }

    stage('SBOM: Syft') {
      steps {
        sh '''
          set -eux
          mkdir -p "${REPORTS_DIR}"
          syft dir:. -o cyclonedx-json="${REPORTS_DIR}/sbom.cdx.json"
        '''
      }
    }

    stage('Vuln Scan: Trivy FS') {
      steps {
        sh '''
          set -eux
          mkdir -p "${REPORTS_DIR}"
          # Non-blocking for now; weâ€™ll enforce thresholds next

          # Full scan report to produce artifact
          trivy fs --format json -o reports/trivy-fs.json . || true
          # Gate: fail on CRITICAL vulns (vuln scanner only to reduce noise)
          trivy fs --scanners vuln --severity CRITICAL --exit-code 1 .
        '''
      }
    }

    stage('SAST: SonarQube') {
      steps {
        container('tools') {
          withSonarQubeEnv('SonarQube') {
            sh '''
              set -eux
              # Ensure scanner can write temp files
              export HOME="$WORKSPACE"

              sonar-scanner \
                -Dsonar.projectBaseDir="$WORKSPACE" \
                -Dsonar.login="$SONAR_AUTH_TOKEN"
            '''
          }
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', allowEmptyArchive: true

      emailext (
        subject: "${currentBuild.currentResult}: Build ${env.BUILD_NUMBER} - ${env.JOB_NAME}",
        body: """
        <html><body>
          <h2 style="color: ${currentBuild.currentResult == 'SUCCESS' ? 'green' : 'red'};">
            Status: ${currentBuild.currentResult}
          </h2>
          <p><b>Build:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
          <p><b>Artifacts:</b> reports/* (Semgrep, SBOM, Trivy)</p>
        </body></html>
        """,
        to: 'dev-team@mailpit.local'
      )
    }
  }
}
