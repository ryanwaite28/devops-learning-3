pipeline {
  agent {
    kubernetes {
      label 'k8s-agent-smoke'
      defaultContainer 'tools'
      yaml """
apiVersion: v1
kind: Pod
spec:
  volumes:
    - name: trivy-cache
      emptyDir: {}

  serviceAccountName: jenkins-ci
  restartPolicy: Never
  securityContext:
    fsGroup: 1000

  containers:
    - name: jnlp
      image: jenkins/inbound-agent:jdk17
      resources:
        requests: { cpu: "100m", memory: "256Mi" }
        limits:   { cpu: "500m", memory: "512Mi" }

    - name: tools
      image: ci-tools:0.1.0
      imagePullPolicy: IfNotPresent
      command: ["bash", "-lc", "cat"]
      tty: true
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      resources:
        requests: { cpu: "200m", memory: "512Mi" }
        limits:   { cpu: "1000m", memory: "1Gi" }
      volumeMounts:
        - name: trivy-cache
          mountPath: /home/jenkins/agent/.cache/trivy
"""
    }
  }

  options {
    timestamps()
    ansiColor('xterm')              // requires AnsiColor plugin (you already fixed this)
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
    timeout(time: 30, unit: 'MINUTES')
  }

  environment {
    REPORTS_DIR = "reports"

    // Put ALL tool state under workspace so it’s writable + reproducible
    CI_HOME         = "${env.WORKSPACE}"
    HOME            = "${env.WORKSPACE}"
    XDG_CACHE_HOME  = "${env.WORKSPACE}/.cache"
    XDG_CONFIG_HOME = "${env.WORKSPACE}/.config"

    SEMGREP_USER_HOME            = "${env.WORKSPACE}/.semgrep"
    SEMGREP_DISABLE_VERSION_CHECK = "1"
    SEMGREP_SEND_METRICS          = "off"

    // Trivy will still use the mounted cache path (inside /home/jenkins/agent/.cache/trivy),
    // but we also create workspace cache dirs for any other tool needs.
    TRIVY_CACHE_DIR = "/home/jenkins/agent/.cache/trivy"

    // Sonar scanner uses ~/.sonar/cache; keep it workspace-local
    SONAR_USER_HOME = "${env.WORKSPACE}/.sonar"
  }

  stages {

    stage('SCM + Agent Smoke Test') {
      steps {
        sh '''
          set -eux
          echo "Hello from Kubernetes agent"
          uname -a
          id
          pwd
          ls -la
        '''
      }
    }

    stage('Prepare CI Workspace') {
      steps {
        sh '''
          set -eux
          mkdir -p "$REPORTS_DIR" \
                 "$XDG_CACHE_HOME" "$XDG_CONFIG_HOME" \
                 "$SEMGREP_USER_HOME" "$SONAR_USER_HOME" \
                 .scannerwork

          # basic write checks
          touch "$XDG_CACHE_HOME/.write_test"
          touch "$XDG_CONFIG_HOME/.write_test"
          touch "$SEMGREP_USER_HOME/.write_test"
          touch "$SONAR_USER_HOME/.write_test"
          rm -f "$XDG_CACHE_HOME/.write_test" "$XDG_CONFIG_HOME/.write_test" \
                "$SEMGREP_USER_HOME/.write_test" "$SONAR_USER_HOME/.write_test"
        '''
      }
    }

    stage('Tool Versions') {
      steps {
        sh '''
          set -eux
          echo "== versions =="
          semgrep --version || true
          syft version
          trivy --version
          sonar-scanner --version
          yq --version
        '''
      }
    }

    stage('Config / YAML Sanity') {
      steps {
        sh '''
          set -eux

          echo "== basic YAML parse checks =="
          # yq will exit non-zero if YAML is invalid
          find . -type f \\( -name '*.yml' -o -name '*.yaml' \\) \
            -not -path './.git/*' \
            -not -path './reports/*' \
            -print0 | xargs -0 -I{} sh -lc 'yq e "." "{}" > /dev/null'

          echo "YAML parse OK"
        '''
      }
    }

    stage('Policy Checks (optional placeholders)') {
      steps {
        sh '''
          set -eux

          echo "== kubeconform/conftest placeholders =="
          # If/when you add kubeconform + conftest into ci-tools:
          # kubeconform -summary -strict -ignore-missing-schemas -kubernetes-version 1.29.0 kubernetes/**/*.yaml
          # conftest test kubernetes/**/*.yaml --policy policy/opa --output json > reports/conftest.json

          echo "Skipping (tools not yet enforced)."
        '''
      }
    }

    stage('SAST: Semgrep (IaC + pipeline files)') {
      steps {
        sh '''
          set -eux
          mkdir -p "$REPORTS_DIR"

          # Keep semgrep fully offline-ish + quiet
          semgrep --metrics off --config p/ci \
            --json -o "$REPORTS_DIR/semgrep.json" . || true

          # Gate: fail only on HIGH/CRITICAL (more realistic than “any finding fails”)
          python3 - <<'PY'
import json, sys

p="reports/semgrep.json"
data=json.load(open(p))
results=data.get("results", []) or []

def sev(r):
    # Semgrep sometimes uses extra.severity; if missing treat as INFO
    return ((r.get("extra") or {}).get("severity") or "INFO").upper()

block = {"HIGH","CRITICAL"}
blocked = [r for r in results if sev(r) in block]

print(f"Semgrep total findings: {len(results)}")
print(f"Semgrep HIGH/CRITICAL findings: {len(blocked)}")

# Uncomment to list blocked findings
# for r in blocked:
#   print(r.get("check_id"), r.get("path"), r.get("start",{}).get("line"), sev(r))

sys.exit(1 if len(blocked) > 0 else 0)
PY
        '''
      }
    }

    stage('SBOM: Syft') {
      steps {
        sh '''
          set -eux
          mkdir -p "$REPORTS_DIR"
          syft dir:. -o cyclonedx-json="$REPORTS_DIR/sbom.cdx.json"
        '''
      }
    }

    stage('Vuln Scan: Trivy FS') {
      steps {
        sh '''
          set -eux
          mkdir -p "$REPORTS_DIR"

          # Full report artifact (non-blocking)
          trivy fs --format json -o "$REPORTS_DIR/trivy-fs.json" . || true

          # Gate: fail on CRITICAL vulns (vuln scanner only to reduce noise)
          trivy fs --scanners vuln --severity CRITICAL --exit-code 1 .
        '''
      }
    }

    stage('SAST: SonarQube (IaC)') {
      steps {
        withSonarQubeEnv('SonarQube') {
          sh '''
            set -eux
            # sonar-project.properties in repo is used automatically.
            # Ensure sonar user home is writable:
            export SONAR_USER_HOME="$SONAR_USER_HOME"

            sonar-scanner \
              -Dsonar.projectBaseDir="$WORKSPACE" \
              -Dsonar.login="$SONAR_AUTH_TOKEN"
          '''
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Security Summary') {
      steps {
        sh '''
          set -eux
          python3 - <<'PY'
import json, datetime

def read_json(path):
    try:
        with open(path) as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

sem = read_json("reports/semgrep.json")
trv = read_json("reports/trivy-fs.json")

sem_results = sem.get("results", []) or []
sem_total = len(sem_results)

def sem_sev(r):
    return ((r.get("extra") or {}).get("severity") or "INFO").upper()

sem_counts = {}
for r in sem_results:
    s = sem_sev(r)
    sem_counts[s] = sem_counts.get(s, 0) + 1

sev_counts = {}
for r in (trv.get("Results") or []):
    for v in (r.get("Vulnerabilities") or []):
        sev = (v.get("Severity") or "UNKNOWN").upper()
        sev_counts[sev] = sev_counts.get(sev, 0) + 1

now = datetime.datetime.utcnow().isoformat() + "Z"

lines = []
lines.append("# CI Security Summary")
lines.append(f"- Generated: {now}")
lines.append("")
lines.append("## Semgrep (SAST)")
lines.append(f"- Total findings: {sem_total}")
if sem_counts:
    for k in ["CRITICAL","HIGH","MEDIUM","LOW","INFO","UNKNOWN"]:
        if k in sem_counts:
            lines.append(f"- {k}: {sem_counts[k]}")
lines.append("")
lines.append("## Trivy FS (Vulnerabilities)")
if sev_counts:
    for k in ["CRITICAL","HIGH","MEDIUM","LOW","UNKNOWN"]:
        if k in sev_counts:
            lines.append(f"- {k}: {sev_counts[k]}")
else:
    lines.append("- No vulnerabilities parsed (or none found).")
lines.append("")
lines.append("## SonarQube")
lines.append("- See the Jenkins console output for the dashboard link and the enforced quality gate result.")
lines.append("")

open("reports/summary.md","w").write("\\n".join(lines))
print("\\n".join(lines))
PY
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', allowEmptyArchive: true

      emailext(
        subject: "${currentBuild.currentResult}: Build ${env.BUILD_NUMBER} - ${env.JOB_NAME}",
        body: """
        <html><body>
          <h2 style="color: ${currentBuild.currentResult == 'SUCCESS' ? 'green' : 'red'};">
            Status: ${currentBuild.currentResult}
          </h2>
          <p><b>Build:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
          <p><b>Artifacts:</b> reports/* (Semgrep JSON, SBOM, Trivy JSON, summary.md)</p>
        </body></html>
        """,
        to: 'dev-team@mailpit.local'
      )
    }
  }
}
