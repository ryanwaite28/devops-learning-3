üöÄ Phase 4A.2 ‚Äî Jenkins pipeline: SAST + SBOM + vuln scanning + SonarQube Quality Gate
Current task

Update your Jenkins pipeline to run these in order, inside the tools container:

Semgrep (SAST)

Syft (SBOM)

Trivy filesystem scan

SonarQube analysis

Quality Gate (pipeline fails if gate fails)

Archive artifacts (SBOM + scan reports)

Step 0 ‚Äî Make the tools image available to Kubernetes agents

Since your Jenkins agents run in kind, they need access to ci-tools:0.1.0.

Do this:

kind load docker-image ci-tools:0.1.0 --name kube-lab


Then update your pod YAML in Jenkinsfile so the tools container uses:

image: ci-tools:0.1.0
imagePullPolicy: IfNotPresent


This eliminates Docker Hub pulls and prevents ErrImagePull.

Step 1 ‚Äî Add SonarQube platform services (if not already)

If you haven‚Äôt stood it up yet, do the compose services we discussed:

sonarqube

sonarqube-db

Make sure Jenkins can reach it at http://sonarqube:9000 (compose DNS).

Step 2 ‚Äî Create sonar-project.properties

In your repo root (or app root), add:

sonar.projectKey=kube-platform-engineering-lab
sonar.projectName=kube-platform-engineering-lab
sonar.sources=.
sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.git/**,**/vendor/**

Step 3 ‚Äî Jenkinsfile (drop-in pipeline skeleton)

Use this as your next iteration. It assumes your job uses ‚ÄúPipeline from SCM‚Äù.

pipeline {
  agent {
    kubernetes {
      label 'k8s-agent-secure'
      defaultContainer 'tools'
      yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-ci
  restartPolicy: Never
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:jdk17
    resources:
      requests: { cpu: "100m", memory: "256Mi" }
      limits:   { cpu: "500m", memory: "512Mi" }
  - name: tools
    image: ci-tools:0.1.0
    imagePullPolicy: IfNotPresent
    command: ["bash", "-lc", "cat"]
    tty: true
    resources:
      requests: { cpu: "200m", memory: "512Mi" }
      limits:   { cpu: "1000m", memory: "1Gi" }
"""
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('SAST: Semgrep') {
      steps {
        sh '''
          mkdir -p reports
          semgrep --version
          # Keep rules simple for now; we can add custom rules later
          semgrep --config p/ci --json -o reports/semgrep.json || true
        '''
      }
    }

    stage('SBOM: Syft') {
      steps {
        sh '''
          mkdir -p reports
          syft dir:. -o cyclonedx-json=reports/sbom.cdx.json
        '''
      }
    }

    stage('Vuln Scan: Trivy (fs)') {
      steps {
        sh '''
          mkdir -p reports
          trivy fs --version
          # Fail behavior: start informational, then tighten later
          trivy fs --format json -o reports/trivy-fs.json . || true
        '''
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv('sonarqube') {
          sh '''
            sonar-scanner \
              -Dsonar.projectKey=kube-platform-engineering-lab \
              -Dsonar.projectName=kube-platform-engineering-lab
          '''
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', allowEmptyArchive: true
    }
  }
}

Why || true for scans initially?

So you can get the pipeline running end-to-end first.
In the next step we‚Äôll implement policy gates that fail on defined thresholds (e.g., ‚Äúfail on any Critical in Trivy‚Äù, ‚Äúfail on Semgrep findings in certain rulesets‚Äù).

Your move

Run:

kind load docker-image ci-tools:0.1.0 --name kube-lab


Update Jenkinsfile to use ci-tools:0.1.0 for the tools container

Stand up SonarQube (if not already)

Configure Jenkins SonarQube server + webhook

Reply back with:

output of the kind load ... command

Jenkins console output through ‚ÄúQuality Gate‚Äù (even if it fails)

whether SonarQube is reachable on localhost:9000

Then we‚Äôll tighten this into a true enterprise gate policy (fail conditions + PR-style reporting).

ChatGPT can make mistakes. Check important info.